import{a as I,f as m,r as d}from"./tags.58927cde.js";import{d as T,a as A,S as E}from"./store-keys.5b62d166.js";import{w as $}from"./index.07c02568.js";import{g}from"./tag-type-data.934b5280.js";const v=(t,s,a=T,e=A)=>{let n;n=localStorage.getItem("kurosearch:localstorage-enabled")==="true"?localStorage:sessionStorage;const r=n?n.getItem(t):null,o=U(s,r,e),i=$(o);return i.subscribe(c=>{sessionStorage.setItem(t,a(c)),localStorage.setItem(t,a(c))}),i},U=(t,s,a)=>{if(s===null)return t;try{const e=a(s);return e===void 0?t:!Array.isArray(e)&&typeof e=="object"&&typeof t=="object"?{...t,...e}:e}catch{return t}},j=()=>{const{subscribe:t,update:s,set:a}=v(E.ActiveTags,[]);return{subscribe:t,set:a,addOrReplace:e=>s(n=>{const r=n.findIndex(o=>o.name===e.name);return r===-1?n.push(e):n[r]=e,n}),addByName:async e=>{let n={modifier:"+",name:e,count:0,type:"general"};try{const r=await I(e);n.count=r.count,n.type=r.type}catch{}s(r=>(r.some(o=>o.name===e)||r.push(n),r))},removeByName:e=>s(n=>{const r=n.findIndex(o=>o.name===e);return n.splice(r,1),n}),reset:()=>a([])}},Z=j();let u=new Map;const C=20;let h=null;const k=async(t,s)=>{const a=F(t,s),e=await m(a,h);l(e);try{const r=(await e.json()).map(f);return r.forEach(o=>{u.set(o.id,o)}),r}catch(n){return console.warn("Failed to get posts",n),[]}},J=async t=>{const s=await m(M(t),h);l(s);const a=await s.text(),n=new DOMParser().parseFromString(a,"text/xml"),r=Number(n.getElementsByTagName("posts")[0].getAttribute("count"));return R(r),r},Q=async t=>{if(!u.has(t)){const a=new URL("https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1");a.searchParams.append("id",String(t));const e=await fetch(a);l(e);const n=await e.json(),r=f(n[0]);u.set(r.id,r)}const s=u.get(t);if(s===void 0)throw new Error("Post cannot be undefined");return s},l=t=>{if(!t.ok)throw new Error(`getPage failed with http status ${t.status}`)},f=t=>{const s=t.height,a=t.score,e=t.preview_url,n=t.file_url,r=t.parent_id,o=t.sample_url,i=t.sample_width,c=t.sample_height,b=t.rating,p=t.tag_info,w=t.tags,y=t.id,x=t.width,_=t.change,P=t.comment_count,S=t.status,N=t.source;return{preview_url:e,sample_url:o,file_url:n,comment_count:Number(P),height:Number(s),id:Number(y),change:Number(_)*1e3,parent_id:r?Number(r):void 0,rating:b,sample_height:Number(c),sample_width:Number(i),score:Number(a),source:N,status:S,tags:p?O(p):q(w),width:Number(x),type:G(n)}},O=t=>t.map(B).sort(W),q=t=>t.split(" ").map(D),B=({tag:t,count:s,type:a})=>({name:d(t),count:s,type:a}),D=t=>({name:d(t),count:0,type:"ambiguous"}),W=(t,s)=>g(t.type)-g(s.type),F=(t,s)=>{const e=`https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1&limit=${C}&pid=${t}`;return s===""?e:`${e}&tags=${s}`},M=t=>{const s="https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&limit=0";return t===""?s:`${s}&tags=${t}`},R=t=>{if(typeof t!="number")throw new Error("Unexpected response received in getPage")},G=t=>t.endsWith(".webm")||t.endsWith(".mp4")?"video":t.includes(".gif")?"gif":"image";export{Z as a,k as b,J as c,F as d,Q as g,v as s};
