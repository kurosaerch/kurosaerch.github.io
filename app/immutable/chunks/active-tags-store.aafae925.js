import{f as m,r as d,a as I}from"./tags.58927cde.js";import{g as p}from"./tag-type-data.934b5280.js";import{d as T,a as A,S as E}from"./store-keys.3fb7abd8.js";import{w as $}from"./index.07c02568.js";let u=new Map;const v=20;let h=null;const Z=async(t,e)=>{const a=B(t,e);console.log(a);const s=await m(a,h);l(s);try{const r=(await s.json()).map(f);return r.forEach(o=>{u.set(o.id,o)}),r}catch(n){return console.warn("Failed to get posts",n),[]}},k=async t=>{const e=await m(D(t),h);l(e);const a=await e.text(),n=new DOMParser().parseFromString(a,"text/xml"),r=Number(n.getElementsByTagName("posts")[0].getAttribute("count"));return W(r),r},J=async t=>{if(!u.has(t)){const a=new URL("https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1");a.searchParams.append("id",String(t));const s=await fetch(a);l(s);const n=await s.json(),r=f(n[0]);u.set(r.id,r)}const e=u.get(t);if(e===void 0)throw new Error("Post cannot be undefined");return e},l=t=>{if(!t.ok)throw new Error(`getPage failed with http status ${t.status}`)},f=t=>{const e=t.height,a=t.score,s=t.preview_url,n=t.file_url,r=t.parent_id,o=t.sample_url,i=t.sample_width,c=t.sample_height,b=t.rating,g=t.tag_info,w=t.tags,y=t.id,x=t.width,_=t.change,P=t.comment_count,S=t.status,N=t.source;return{preview_url:s,sample_url:o,file_url:n,comment_count:Number(P),height:Number(e),id:Number(y),change:Number(_)*1e3,parent_id:r?Number(r):void 0,rating:b,sample_height:Number(c),sample_width:Number(i),score:Number(a),source:N,status:S,tags:g?U(g):j(w),width:Number(x),type:F(n)}},U=t=>t.map(C).sort(q),j=t=>t.split(" ").map(O),C=({tag:t,count:e,type:a})=>({name:d(t),count:e,type:a}),O=t=>({name:d(t),count:0,type:"ambiguous"}),q=(t,e)=>p(t.type)-p(e.type),B=(t,e)=>{const s=`https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1&limit=${v}&pid=${t}`;return e===""?s:`${s}&tags=${e}`},D=t=>{const e="https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&limit=0";return t===""?e:`${e}&tags=${t}`},W=t=>{if(typeof t!="number")throw new Error("Unexpected response received in getPage")},F=t=>t.endsWith(".webm")||t.endsWith(".mp4")?"video":t.includes(".gif")?"gif":"image",M=(t,e,a=T,s=A)=>{let n;n=localStorage.getItem("kurosearch:localstorage-enabled")==="true"?localStorage:sessionStorage;const r=n?n.getItem(t):null,o=R(e,r,s),i=$(o);return i.subscribe(c=>{sessionStorage.setItem(t,a(c)),localStorage.setItem(t,a(c))}),i},R=(t,e,a)=>{if(e===null)return t;try{const s=a(e);return s===void 0?t:!Array.isArray(s)&&typeof s=="object"&&typeof t=="object"?{...t,...s}:s}catch{return t}},G=()=>{const{subscribe:t,update:e,set:a}=M(E.ActiveTags,[]);return{subscribe:t,set:a,addOrReplace:s=>e(n=>{const r=n.findIndex(o=>o.name===s.name);return r===-1?n.push(s):n[r]=s,n}),addByName:async s=>{let n={modifier:"+",name:s,count:0,type:"general"};try{const r=await I(s);n.count=r.count,n.type=r.type}catch{}e(r=>(r.push(n),r))},removeByName:s=>e(n=>{const r=n.findIndex(o=>o.name===s);return n.splice(r,1),n}),reset:()=>a([])}},Q=G();export{Q as a,Z as b,k as c,B as d,J as g,M as s};
