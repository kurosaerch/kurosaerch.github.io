var V=Object.defineProperty;var T=(s,t,r)=>t in s?V(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r;var n=(s,t,r)=>(T(s,typeof t!="symbol"?t+"":t,r),r);import{s as g,b as z,c as U,d as $}from"./active-tags-store.b3e4fe76.js";import{S as l}from"./store-keys.b00e21d8.js";import{a as I}from"./tag-utils.ceb6413c.js";import{B as k}from"./blocked-content-store.9c031c36.js";const f=()=>({posts:[],pageCount:0,ids:new Set,postCount:0,requested:!1}),D=s=>JSON.stringify({posts:s.posts,pageCount:s.pageCount,ids:[...s.ids.values()],postCount:s.postCount,requested:s.requested}),R=s=>{const t=JSON.parse(s);return{posts:t.posts,pageCount:t.pageCount,ids:new Set(t.ids),postCount:t.postCount,requested:t.requested}},j=()=>{const{subscribe:s,update:t,set:r}=g(l.Results,f(),D,R);return{subscribe:s,addPage(e,i=void 0){t(o=>{const a=e.filter(h=>!o.ids.has(h.id));return a.forEach(h=>o.ids.add(h.id)),{posts:[...o.posts,...a],pageCount:o.pageCount+1,ids:o.ids,postCount:i??o.postCount,requested:!0}})},reset(){r(f())}}},Z=j(),C=()=>({property:"id",direction:"desc"}),A=()=>{const{subscribe:s,set:t,update:r}=g(l.Sort,C());return{subscribe:s,set:t,update(e){r(i=>({...i,...e}))},reset(){t(C())}}},v=A(),b=()=>({scoreValue:0,scoreComparator:">=",rating:"all"}),B=()=>{const{subscribe:s,set:t,update:r}=g(l.Filter,b());return{subscribe:s,set(e){t({...e,scoreValue:e.scoreValue??0})},update(e){r(i=>({...i,...e}))},reset(){t(b())}}},tt=B(),N=s=>s==="-"?"-":"",P=s=>s.replaceAll(" ","_"),q=s=>`${N(s.modifier)}${P(s.name)}`,m=s=>{const t=E(s);let r=[...y([...t["+"],...t["-"]])];return t["~"].length>0&&r.push(`( ${y(t["~"]).join(" ~ ")} )`),r.join("+")},p=(s,t,r,e,i,o,a,h)=>{const c=[`sort:${t}:${r}`];if((e!==0||o!==">=")&&c.push(`score:${o}${e}`),i!=="all"&&c.push(`rating:${i}`),s.length>0&&c.push(m(s)),h.length>0){const u=h.map(d=>m(d.tags)).join("+");c.push(u)}if(a.length>0){const u=a.flatMap(S=>k[S]).map(S=>({modifier:"-",name:S})),d=m(u);c.push(d)}return c.join("+")},y=s=>s.map(q),E=s=>{const t={"+":[],"-":[],"~":[]};return s.forEach(r=>t[r.modifier].push(r)),t},w=";",O=s=>{debugger;return s.replaceAll(" ","+").split(w).map(t=>t.trim()).map(t=>I(t.charAt(0),t.substring(1)))},M=s=>s.map(t=>`${t.modifier}${P(t.name)}`).join(w),st=s=>({tags:O(s.get("tags")??""),sort:x(s),filter:G(s)}),_=s=>{const t=new URLSearchParams,{tags:r,sort:e,filter:i}=s;return r&&r.length>0&&t.append("tags",M(r)),e&&(e.property!=="id"||(e==null?void 0:e.direction)!=="desc")&&t.append("sort",F(e)),i&&(i.rating!=="all"||i.scoreComparator!==">="||i.scoreValue!==0)&&t.append("filter",L(i)),t},F=s=>s.property+":"+s.direction,L=s=>{const t=[];if(s.rating!=="all"){const r="rating:"+s.rating;t.push(r)}if(s.scoreComparator!==">="||s.scoreValue!==0){const r="score"+s.scoreComparator+s.scoreValue;t.push(r)}return t.join(";")},x=s=>{try{if(!s.has("sort"))return;const t=s.get("sort")??"",[r,e]=t.split(":");return{property:r,direction:e}}catch{console.warn("Invalid sort provided in url");return}},G=s=>{try{if(!s.has("filter"))return;const r=(s.get("filter")??"").split(";");let e={};return r.forEach(i=>{if(i.startsWith("rating:")){const[,o]=i.split(":");o!=="all"&&(e.rating=o)}if(i.startsWith("score")){const o=i.match(/score(..)(\d+)/);if(o){const[,a,h]=o;e.scoreComparator=a;const c=Number(h);c&&(e.scoreValue=c)}}}),e}catch{console.warn("Invalid sort provided in url");return}},rt=(s,t,r)=>{const e=new URL(location.protocol+"//"+location.host+"/share");return _({tags:s,sort:t,filter:r}).forEach((o,a)=>{e.searchParams.set(a,o)}),e};class et{constructor(){n(this,"pid");n(this,"tags");n(this,"supertags");n(this,"blockedContent");n(this,"sortProperty");n(this,"sortDirection");n(this,"scoreValue");n(this,"rating");n(this,"scoreComparator");n(this,"tagString");this.pid=0,this.tags=[],this.supertags=[],this.blockedContent=[],this.sortProperty="id",this.sortDirection="desc",this.scoreValue=0,this.rating="all",this.scoreComparator=">="}withPid(t){return this.pid=t,this}withTags(t){return this.tags=t,this}withSupertags(t){return this.supertags=t,this}withSortProperty(t){return this.sortProperty=t,this}withSortDirection(t){return this.sortDirection=t,this}withScoreValue(t){return this.scoreValue=t,this}withScoreComparator(t){return this.scoreComparator=t,this}withRating(t){return this.rating=t,this}withBlockedContent(t){return this.blockedContent=Object.entries(t).filter(([r,e])=>e).map(([r,e])=>r),this}async getPageAndCount(){return this.tagString=p(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags),Promise.all([this.getPage(),this.getCount()])}async getPage(){return this.tagString||(this.tagString=p(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),z(this.pid,this.tagString)}async getCount(){return this.tagString||(this.tagString=p(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),U(this.tagString)}getQuery(){return this.tagString||(this.tagString=p(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),$(0,this.tagString)}}const W=()=>{const{subscribe:s,update:t,set:r}=g(l.ActiveSupertags,[]);return{subscribe:s,set:r,addOrReplace:e=>t(i=>{const o=i.findIndex(a=>a.name===e.name);return o===-1?i.push(e):i[o]=e,i}),removeByName:e=>t(i=>{const o=i.findIndex(a=>a.name===e);return i.splice(o,1),i}),reset:()=>r([])}},it=W();export{et as S,it as a,tt as f,rt as g,st as p,Z as r,v as s};
