import{f as g,r as d,a as I}from"./tags.49324235.js";import{g as m}from"./tag-type-data.934b5280.js";import{d as T,e as A,S as E}from"./store-keys.19bfcc67.js";import{w as $}from"./index.6292979b.js";const v=(t,s,o=T,e=A)=>{let n;n=localStorage.getItem("kurosearch:localstorage-enabled")==="true"?localStorage:sessionStorage;const r=n?n.getItem(t):null,a=U(s,r,e),c=$(a);return c.subscribe(i=>{sessionStorage.setItem(t,o(i)),localStorage.setItem(t,o(i))}),c},U=(t,s,o)=>{if(s===null)return t;try{const e=o(s);return e===void 0?t:!Array.isArray(e)&&typeof e=="object"&&typeof t=="object"?{...t,...e}:e}catch{return t}};let u=new Map;const j=20;let h=null;const Z=async(t,s)=>{const o=W(t,s),e=await g(o,h);l(e);try{const r=(await e.json()).map(f);return r.forEach(a=>{u.set(a.id,a)}),r}catch(n){return console.warn("Failed to get posts",n),[]}},k=async t=>{const s=await g(F(t),h);l(s);const o=await s.text(),n=new DOMParser().parseFromString(o,"text/xml"),r=Number(n.getElementsByTagName("posts")[0].getAttribute("count"));return M(r),r},J=async t=>{if(!u.has(t)){const o=new URL("https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1");o.searchParams.append("id",String(t));const e=await fetch(o);l(e);const n=await e.json(),r=f(n[0]);u.set(r.id,r)}const s=u.get(t);if(s===void 0)throw new Error("Post cannot be undefined");return s},l=t=>{if(!t.ok)throw new Error(`getPage failed with http status ${t.status}`)},f=t=>{const s=t.height,o=t.score,e=t.preview_url,n=t.file_url,r=t.parent_id,a=t.sample_url,c=t.sample_width,i=t.sample_height,b=t.rating,p=t.tag_info,w=t.tags,y=t.id,x=t.width,_=t.change,P=t.comment_count,S=t.status,N=t.source;return{preview_url:e,sample_url:a,file_url:n,comment_count:Number(P),height:Number(s),id:Number(y),change:Number(_)*1e3,parent_id:r?Number(r):void 0,rating:b,sample_height:Number(i),sample_width:Number(c),score:Number(o),source:N,status:S,tags:p?C(p):O(w),width:Number(x),type:R(n)}},C=t=>t.map(q).sort(D),O=t=>t.split(" ").map(B),q=({tag:t,count:s,type:o})=>({name:d(t),count:s,type:o}),B=t=>({name:d(t),count:0,type:"ambiguous"}),D=(t,s)=>m(t.type)-m(s.type),W=(t,s)=>{const e=`https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1&limit=${j}&pid=${t}`;return s===""?e:`${e}&tags=${s}`},F=t=>{const s="https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&limit=0";return t===""?s:`${s}&tags=${t}`},M=t=>{if(typeof t!="number")throw new Error("Unexpected response received in getPage")},R=t=>t.endsWith(".webm")||t.endsWith(".mp4")?"video":t.includes(".gif")?"gif":"image",G=()=>{const{subscribe:t,update:s,set:o}=v(E.ActiveTags,[]);return{subscribe:t,set:o,addOrReplace:e=>s(n=>{const r=n.findIndex(a=>a.name===e.name);return r===-1?n.push(e):n[r]=e,n}),addByName:async(e,n="+")=>{let r={modifier:n,name:e,count:0,type:"general"};try{const a=await I(e);r.count=(a==null?void 0:a.count)??0,r.type=(a==null?void 0:a.type)??"tag"}catch{}s(a=>(a.some(c=>c.name===e)||a.push(r),a))},removeByName:e=>s(n=>{const r=n.findIndex(a=>a.name===e);return n.splice(r,1),n}),reset:()=>o([])}},Q=G();export{Q as a,Z as b,k as c,W as d,J as g,v as s};
