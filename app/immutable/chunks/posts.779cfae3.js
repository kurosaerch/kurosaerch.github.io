import{a as I,f as g,r as d}from"./tags.49324235.js";import{d as T,a as A,S as E}from"./store-keys.5b62d166.js";import{w as $}from"./index.07c02568.js";import{g as m}from"./tag-type-data.934b5280.js";const v=(t,n,a=T,s=A)=>{let r;r=localStorage.getItem("kurosearch:localstorage-enabled")==="true"?localStorage:sessionStorage;const e=r?r.getItem(t):null,o=U(n,e,s),i=$(o);return i.subscribe(c=>{sessionStorage.setItem(t,a(c)),localStorage.setItem(t,a(c))}),i},U=(t,n,a)=>{if(n===null)return t;try{const s=a(n);return s===void 0?t:!Array.isArray(s)&&typeof s=="object"&&typeof t=="object"?{...t,...s}:s}catch{return t}},j=()=>{const{subscribe:t,update:n,set:a}=v(E.ActiveTags,[]);return{subscribe:t,set:a,addOrReplace:s=>n(r=>{const e=r.findIndex(o=>o.name===s.name);return e===-1?r.push(s):r[e]=s,r}),addByName:async s=>{let r={modifier:"+",name:s,count:0,type:"general"};try{const e=await I(s);r.count=(e==null?void 0:e.count)??0,r.type=(e==null?void 0:e.type)??"tag"}catch{}n(e=>(e.some(o=>o.name===s)||e.push(r),e))},removeByName:s=>n(r=>{const e=r.findIndex(o=>o.name===s);return r.splice(e,1),r}),reset:()=>a([])}},Z=j();let u=new Map;const C=20;let h=null;const k=async(t,n)=>{const a=F(t,n),s=await g(a,h);l(s);try{const e=(await s.json()).map(f);return e.forEach(o=>{u.set(o.id,o)}),e}catch(r){return console.warn("Failed to get posts",r),[]}},J=async t=>{const n=await g(M(t),h);l(n);const a=await n.text(),r=new DOMParser().parseFromString(a,"text/xml"),e=Number(r.getElementsByTagName("posts")[0].getAttribute("count"));return R(e),e},Q=async t=>{if(!u.has(t)){const a=new URL("https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1");a.searchParams.append("id",String(t));const s=await fetch(a);l(s);const r=await s.json(),e=f(r[0]);u.set(e.id,e)}const n=u.get(t);if(n===void 0)throw new Error("Post cannot be undefined");return n},l=t=>{if(!t.ok)throw new Error(`getPage failed with http status ${t.status}`)},f=t=>{const n=t.height,a=t.score,s=t.preview_url,r=t.file_url,e=t.parent_id,o=t.sample_url,i=t.sample_width,c=t.sample_height,b=t.rating,p=t.tag_info,w=t.tags,y=t.id,x=t.width,_=t.change,P=t.comment_count,S=t.status,N=t.source;return{preview_url:s,sample_url:o,file_url:r,comment_count:Number(P),height:Number(n),id:Number(y),change:Number(_)*1e3,parent_id:e?Number(e):void 0,rating:b,sample_height:Number(c),sample_width:Number(i),score:Number(a),source:N,status:S,tags:p?O(p):q(w),width:Number(x),type:G(r)}},O=t=>t.map(B).sort(W),q=t=>t.split(" ").map(D),B=({tag:t,count:n,type:a})=>({name:d(t),count:n,type:a}),D=t=>({name:d(t),count:0,type:"ambiguous"}),W=(t,n)=>m(t.type)-m(n.type),F=(t,n)=>{const s=`https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&fields=tag_info&json=1&limit=${C}&pid=${t}`;return n===""?s:`${s}&tags=${n}`},M=t=>{const n="https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&limit=0";return t===""?n:`${n}&tags=${t}`},R=t=>{if(typeof t!="number")throw new Error("Unexpected response received in getPage")},G=t=>t.endsWith(".webm")||t.endsWith(".mp4")?"video":t.includes(".gif")?"gif":"image";export{Z as a,k as b,J as c,F as d,Q as g,v as s};
